<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>
<style>
/* ===== Mixed UI: clean new look + restored old controls ===== */
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f5f6fa;
  transition: background 0.25s ease, color 0.25s ease;
  color: #222;
}
body.dark { background:#2c3e50; color:#ecf0f1; }
h2 { margin:0 0 10px 0; font-size:32px; color:#333; }
body.dark h2{ color:#ecf0f1; }

#status { color:#7d8794; margin-bottom:10px; font-style:italic; }

/* Top bar & buttons */
.topbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn { padding:8px 12px; border-radius:6px; border: none; cursor:pointer; }
.btn-primary { background:#007bff; color:white; box-shadow: 0 2px 0 rgba(0,0,0,0.05); }
.btn-secondary { background:#eee; color:#222; border-radius:6px; }

/* toggles kept like old repo */
.toggles { display:flex; gap:12px; align-items:center; margin-left:6px; }
.toggle { position:relative; width:50px; height:26px; display:inline-block; }
.toggle input { opacity:0; width:0; height:0; }
.slider { position:absolute; inset:0; background:#ccc; border-radius:26px; transition:0.2s; }
.slider:before { content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:white; border-radius:50%; transition:0.2s; }
.toggle input:checked + .slider { background:#007bff; }
.toggle input:checked + .slider:before { transform:translateX(24px); }

/* Search */
#search { padding:12px; width:420px; max-width:100%; border-radius:8px; border:1px solid #ccc; margin:10px 0; }

/* Table */
table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
th { background:#e6e9f0; padding:10px; text-align:left; border-bottom:1px solid #dcdde1; }
td { padding:10px; border-bottom:1px solid #efefef; }
.compact td, .compact th { padding:6px; font-size:13px; }

/* Pagination */
.pagination { margin-top:16px; display:flex; align-items:center; gap:8px; }

/* Scanner modal styles */
.modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal { width:820px; max-width:96%; background:#fff; border-radius:10px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
#qr-reader { width:100%; height:360px; background:#000; display:flex; align-items:center; justify-content:center; color:#999; }

/* scan tools row */
.scan-tools { display:flex; justify-content:space-between; gap:10px; margin-top:12px; align-items:center; }
.scan-btn { padding:10px 14px; border-radius:6px; border:1px solid #007bff; background:#fff; color:#007bff; cursor:pointer; }

/* small screens */
@media (max-width:768px){
  #search{width:100%;}
  #qr-reader{height:260px;}
  .modal{padding:12px;}
}
</style>
</head>
<body>

<div id="status">Loading data...</div>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">üì∑ Scan (QR / Barcode)</button>
  <button id="btn-refresh" class="btn btn-secondary">‚Üª Refresh</button>

  <div style="flex:1"></div>

  <div class="toggles" title="Toggles">
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Dark</div>
      <label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label>
    </label>
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Compact</div>
      <label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label>
    </label>
  </div>
</div>

<input id="search" type="text" placeholder="Search part / description / category / qty">

<table>
  <thead>
    <tr><th>S.No</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th></tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<div class="pagination">
  <button id="prev-page" class="btn btn-secondary">Prev</button>
  <span id="page-info"></span>
  <button id="next-page" class="btn btn-secondary">Next</button>
</div>

<br>

<input id="jumpPage" type="number" placeholder="Go to page"><button onclick="jumpToPage()" class="btn btn-secondary">Go</button>

<!-- Scanner modal -->
<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Scanner modal">
    <h3 style="margin-top:0;color:#666;">Scanner (QR + Barcode)</h3>
    <div id="qr-reader">Camera preview will appear here</div>

    <div class="scan-tools">
      <div style="display:flex;gap:8px;">
        <button id="btn-flash" class="scan-btn">üî¶ Flash</button>
        <button id="btn-photo" class="scan-btn">üñºÔ∏è Scan From Photo</button>
      </div>
      <div style="font-size:13px;color:#666;">Tip: center code inside the preview</div>
    </div>

    <div style="text-align:right;margin-top:12px;">
      <button id="qr-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<script>
/* ===================== ORIGINAL APP / SHEETDB LOGIC (PRESERVED) ===================== */

let items = [];
let currentPage = 1;
const perPage = 50;
let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';
const statusEl = document.getElementById('status');
const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";

// Mock fallback
const mockData = [
  { "item no":"0720","part no":"0720","description":"0720 AC CONDENSOR NIS PICK UP 02-09","category":"AC PARTS ITEMS","qty":"0" },
  { "item no":"4060-ZC026","part no":"44060-ZC026/SP1512","description":"44060-ZC026 BRAKE PAD RR NIS ARMADA 07-","category":"BRAKE PAD","qty":"25.5" }
];

if(isDark) document.body.classList.add('dark');
if(isCompact) document.body.classList.add('compact');
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

function toggleDark(){ isDark=!isDark; document.body.classList.toggle('dark',isDark); localStorage.setItem('darkMode',isDark); }
function toggleCompact(){ isCompact=!isCompact; document.body.classList.toggle('compact',isCompact); localStorage.setItem('compactMode',isCompact); }
document.getElementById('darkToggle').addEventListener('change', toggleDark);
document.getElementById('compactToggle').addEventListener('change', toggleCompact);

function cleanKeys(row){ let fixed={}; for(let k in row) fixed[k.trim()] = (row[k]+"").trim(); return fixed; }

function display(list){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = "";
  const startIndex = (currentPage-1)*perPage;
  const headers = ['S.No','Item No','Part No','Description','Category','Qty'];
  for(let i=0;i<list.length;i++){
    const r=list[i];
    tbody.innerHTML += `<tr>
      <td data-label="${headers[0]}">${startIndex+i+1}</td>
      <td data-label="${headers[1]}">${r["item no"]||""}</td>
      <td data-label="${headers[2]}">${r["part no"]||""}</td>
      <td data-label="${headers[3]}">${r["description"]||""}</td>
      <td data-label="${headers[4]}">${r["category"]||""}</td>
      <td data-label="${headers[5]}">${r["qty"]||""}</td>
    </tr>`;
  }
}

function render(){
  let q = (document.getElementById('search').value||"").toLowerCase();
  let keywords = q.split(" ").filter(k=>k.trim()!=="");
  let filtered = items.filter(row=>{
    let text = ((row["item no"]||"")+" "+(row["part no"]||"")+" "+(row["description"]||"")+" "+(row["category"]||"")+" "+(row["qty"]||"")).toLowerCase();
    return keywords.every(w => text.includes(w));
  });

  let totalPages = Math.max(1, Math.ceil(filtered.length/perPage));
  if(currentPage>totalPages) currentPage=totalPages;
  let start = (currentPage-1)*perPage;
  display(filtered.slice(start, start+perPage));

  document.getElementById('page-info').innerText = "Page "+currentPage+" of "+totalPages;
  document.getElementById('prev-page').disabled = currentPage===1;
  document.getElementById('next-page').disabled = currentPage===totalPages;
}

document.getElementById('search').addEventListener('input', ()=>{ currentPage=1; render(); });
document.getElementById('prev-page').addEventListener('click', ()=>{ if(currentPage>1) currentPage--; render(); });
document.getElementById('next-page').addEventListener('click', ()=>{ currentPage++; render(); });

function jumpToPage(){ let p=parseInt(document.getElementById('jumpPage').value); if(!isNaN(p)&&p>0){ currentPage=p; render(); } }

function loadData(){
  statusEl.innerText = "Fetching records...";
  fetch(SHEETDB_BASE).then(r=>r.json()).then(data=>{
    items = data.map(cleanKeys);
    statusEl.innerText = "Loaded "+items.length+" records.";
    render();
  }).catch(err=>{
    statusEl.innerText = "Offline mode: using sample data.";
    items = mockData;
    render();
  });
}
loadData();

document.getElementById('btn-refresh').addEventListener('click', loadData);

/* ===================== SCANNER ENHANCEMENTS (QR + EAN-13 photo fallback) ===================== */

let html5QrcodeLoaded = false;
let qrScanner = null;
let scanLock = false;
let currentVideoTrack = null;
let torchOn = false;

// small beep (tiny base64 mp3) - short blip
const beep = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3Ljg0LjEwMAAAAAAA//uQxAADBjQACgAAAAEAAwBCAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==");

function injectScriptText(code){
  return new Promise((resolve,reject)=>{
    try{
      const s=document.createElement('script');
      s.type='text/javascript';
      s.text = code;
      document.head.appendChild(s);
      html5QrcodeLoaded = true;
      resolve();
    }catch(e){ reject(e); }
  });
}

function tryLoadLocal(){
  return new Promise((resolve,reject)=>{
    if(html5QrcodeLoaded) return resolve();
    const s=document.createElement('script');
    s.src = "./html5-qrcode.min.js";
    s.onload = ()=>{ html5QrcodeLoaded=true; resolve(); };
    s.onerror = ()=>{ s.remove(); reject(new Error("local load failed")); };
    document.head.appendChild(s);
  });
}

function tryFetchRawGithub(){
  return new Promise((resolve,reject)=>{
    try{
      const hostname = window.location.hostname;
      const pathParts = (window.location.pathname||"/").split("/").filter(Boolean);
      let rawUrl = "https://raw.githubusercontent.com/mebjas/html5-qrcode/master/dist/html5-qrcode.min.js";
      if(hostname.endsWith("github.io") && pathParts.length>0){
        const username = hostname.split(".")[0];
        const repo = pathParts[0];
        rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/html5-qrcode.min.js`;
      }
      fetch(rawUrl).then(r=>{
        if(!r.ok) throw new Error("raw fetch ok? "+r.status);
        return r.text();
      }).then(txt=>{
        if(!txt || txt.length < 200) throw new Error("raw file too small");
        return injectScriptText(txt);
      }).then(resolve).catch(reject);
    }catch(e){ reject(e); }
  });
}

async function loadHtml5QrcodeScript(){
  if(html5QrcodeLoaded) return;
  try{
    await tryLoadLocal();
    return;
  }catch(e){
    // try raw
  }
  try{
    await tryFetchRawGithub();
    return;
  }catch(e){
    // final fallback to CDN (may be blocked on GitHub Pages)
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
      s.onload = ()=>{ html5QrcodeLoaded=true; resolve(); };
      s.onerror = ()=>reject(new Error("All attempts to load html5-qrcode failed."));
      document.head.appendChild(s);
    });
  }
}

const qrBackdrop = document.getElementById('qr-backdrop');
const qrReader = document.getElementById('qr-reader');
const btnScan = document.getElementById('btn-scan');
const btnClose = document.getElementById('qr-close');
const btnFlash = document.getElementById('btn-flash');
const btnPhoto = document.getElementById('btn-photo');

btnScan.addEventListener('click', openQR);
btnClose.addEventListener('click', closeQR);

/* Safe clear of existing scanner */
function safeClearScanner(){
  if(qrScanner){
    try{
      qrScanner.stop().then(()=>{ try{ qrScanner.clear(); }catch(e){} }).catch(()=>{});
    }catch(e){}
    qrScanner = null;
    currentVideoTrack = null;
    torchOn = false;
  }
}

/* Utility: obtain the internal video element created by Html5Qrcode */
function getScannerVideoElement(){
  if(!qrReader) return null;
  // html5-qrcode places a video element under the container; attempt to find it.
  const vid = qrReader.querySelector('video');
  return vid || null;
}

/* Try to set torch using the current video track capabilities (best-effort) */
async function setTorch(on){
  try{
    const video = getScannerVideoElement();
    if(!video || !video.srcObject) throw new Error("No video stream");
    const track = video.srcObject.getVideoTracks()[0];
    if(!track) throw new Error("No video track");
    const cap = track.getCapabilities ? track.getCapabilities() : {};
    if(cap.torch || (cap && cap.torch === true)){
      await track.applyConstraints({ advanced: [{ torch: on }] });
      torchOn = on;
      return true;
    } else {
      // Some Samsung browsers use 'imageSmoothing' constraints - fallback attempt
      await track.applyConstraints({ advanced: [{ torch: on }] }).catch(()=>{});
      return false;
    }
  }catch(e){
    return false;
  }
}

/* Actual open scanner */
async function openQR(){
  qrBackdrop.style.display = 'flex';
  qrBackdrop.setAttribute('aria-hidden','false');
  scanLock = false;
  safeClearScanner();
  qrReader.innerHTML = ""; // clear previous content

  // Slight delay to ensure modal is visible and sized
  await new Promise(r => requestAnimationFrame(()=>setTimeout(r, 200)));

  try{
    await loadHtml5QrcodeScript();
  }catch(e){
    alert("Scanner library failed to load: " + (e && e.message ? e.message : e));
    qrBackdrop.style.display = 'none';
    return;
  }

  try{
    // create instance
    qrScanner = new Html5Qrcode("qr-reader");

    const config = {
      fps: 15,
      qrbox: null, // full width
      experimentalFeatures: { useBarCodeDetectorIfSupported: true },
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128
      ]
    };

    // IMPORTANT: html5-qrcode requires the first arg to be either a string deviceId OR an object with a single key.
    // We pass facingMode only (one key).
    const cameraConfig = { facingMode: "environment" };

    await qrScanner.start(
      cameraConfig,
      config,
      (decodedText, decodedResult) => {
        if(scanLock) return;
        scanLock = true;
        try{ beep.play().catch(()=>{}); }catch(e){}
        document.getElementById('search').value = decodedText;
        currentPage = 1;
        render();
        // auto-close after slight delay so user sees the scanned value
        setTimeout(()=>{ closeQR(); }, 220);
      },
      (error) => {
        // ignore frequent decode errors
      }
    );

    // after start, try detect video element and keep a reference to track
    setTimeout(()=>{
      const v = getScannerVideoElement();
      if(v && v.srcObject && v.srcObject.getVideoTracks){
        currentVideoTrack = v.srcObject.getVideoTracks()[0];
      }
    }, 600);

  }catch(err){
    console.error("Failed to start scanner:", err);
    alert("Camera failed to start: " + (err && err.message ? err.message : err));
    qrBackdrop.style.display = 'none';
    qrBackdrop.setAttribute('aria-hidden','true');
    safeClearScanner();
  }
}

/* Close scanner and free camera */
function closeQR(){
  qrBackdrop.style.display = 'none';
  qrBackdrop.setAttribute('aria-hidden','true');
  safeClearScanner();
}

/* Flashlight toggle button */
btnFlash.addEventListener('click', async ()=>{
  if(!qrScanner){
    alert("Open scanner first");
    return;
  }
  // Try to toggle
  const success = await setTorch(!torchOn);
  if(!success){
    alert("Flash/torch not supported on this device/browser.");
  }
});

/* ================= Scan From Photo (FIX) =================
   Strategy:
   1) Try html5-qrcode.scanFile(file, tryFlip=true) which decodes QR codes (fast)
   2) If that fails, attempt browser BarcodeDetector (supports EAN-13) on an ImageBitmap
   3) If BarcodeDetector not available or fails, show "not found"
   This supports Option B: QR + EAN-13
*/
btnPhoto.addEventListener('click', ()=> {
  // create a file input on the fly
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      // Ensure library loaded
      await loadHtml5QrcodeScript();
    }catch(e){
      alert("Scanner library not loaded: "+(e&&e.message?e.message:e));
      return;
    }

    // 1) try html5-qrcode's scanFile -> good for QR
    try{
      // If scanner instance exists, prefer using that instance's static scanFile feature
      // html5-qrcode provides a static-like function via created instance.
      let scanResult = null;
      if(qrScanner && typeof qrScanner.scanFile === 'function'){
        scanResult = await qrScanner.scanFile(file, true);
      } else if(typeof Html5Qrcode === 'function' && Html5Qrcode.getCameras){
        // if no instance, create a temp Html5Qrcode instance for scanning the file
        const tmp = new Html5Qrcode();
        if(typeof tmp.scanFile === 'function') scanResult = await tmp.scanFile(file, true);
      }
      if(scanResult){
        // success
        try{ beep.play().catch(()=>{}); }catch(e){}
        document.getElementById('search').value = scanResult;
        currentPage = 1;
        render();
        return;
      }
    }catch(err){
      // console.log("scanFile failed or no result:", err);
    }

    // 2) Try BarcodeDetector for EAN-13 (if supported)
    try{
      if('BarcodeDetector' in window){
        // request formats: EAN_13 (and EAN_8 & UPC_A to be safe)
        const supportedFormats = ['ean_13','ean_8','upc_a'];
        let detector;
        try{
          detector = new BarcodeDetector({formats: supportedFormats});
        }catch(e){
          // Some browsers throw if formats not supported; try default
          detector = new BarcodeDetector();
        }
        // Create ImageBitmap from file
        const bitmap = await createImageBitmap(file);
        const results = await detector.detect(bitmap);
        if(results && results.length>0){
          // take first result
          const val = results[0].rawValue || results[0].rawData || results[0].displayValue || results[0].rawText;
          if(val){
            try{ beep.play().catch(()=>{}); }catch(e){}
            document.getElementById('search').value = val;
            currentPage = 1;
            render();
            return;
          }
        }
      }
    }catch(e){
      // BarcodeDetector might not exist or fail - ignore and continue
      // console.warn('BarcodeDetector failed', e);
    }

    // 3) As last attempt we can try to draw image to canvas and use Html5Qrcode's decode from image element
    try{
      // create an img element
      const img = document.createElement('img');
      img.style.display = 'none';
      document.body.appendChild(img);
      img.src = URL.createObjectURL(file);
      await new Promise((resolve,reject)=>{
        img.onload = ()=>resolve();
        img.onerror = ()=>reject(new Error("image load failed"));
      });

      if(typeof Html5Qrcode === 'function'){
        const tmp = new Html5Qrcode();
        try{
          const result = await tmp.scanFile(file, true); // attempt again (some builds differ)
          if(result){
            try{ beep.play().catch(()=>{}); }catch(e){}
            document.getElementById('search').value = result;
            currentPage = 1;
            render();
            img.remove();
            return;
          }
        }catch(e){}
      }
      // cleanup
      img.remove();
    }catch(e){
      // ignore
    }

    // final: not found
    alert("No QR code or supported barcode found in the selected image.");
  };
  input.click();
});

/* ensure camera is freed on page hide/unload */
window.addEventListener('pagehide', ()=>{ safeClearScanner(); });
window.addEventListener('beforeunload', ()=>{ safeClearScanner(); });

</script>
</body>
</html>