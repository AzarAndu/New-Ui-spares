<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>
<style>
:root{
  --bg:#f5f6fa; --card:#fff; --muted:#7d8794; --primary:#007bff; --text:#222;
  --dark-bg:#2c3e50; --dark-card:#34495e; --dark-text:#ecf0f1;
}
body{font-family:Arial,sans-serif;margin:20px;background:var(--bg);color:var(--text);transition:background .2s,color .2s;}
body.dark{background:var(--dark-bg);color:var(--dark-text);}
h2{margin:0 0 10px 0;font-size:32px;}
#status{color:var(--muted);margin-bottom:10px;font-style:italic;}
.topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
.btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 2px 0 rgba(0,0,0,0.05);}
.btn-secondary{background:#eee;color:#222;}
.toggles{display:flex;gap:12px;align-items:center;margin-left:6px;}
.toggle{position:relative;width:50px;height:26px;display:inline-block;}
.toggle input{opacity:0;width:0;height:0;}
.slider{position:absolute;inset:0;background:#ccc;border-radius:26px;transition:0.2s;}
.slider:before{content:"";position:absolute;left:3px;bottom:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:0.2s;}
.toggle input:checked + .slider{background:var(--primary);}
.toggle input:checked + .slider:before{transform:translateX(24px);}
#search{padding:12px;width:420px;max-width:100%;border-radius:8px;border:1px solid #ccc;margin:10px 0;}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
th{background:#e6e9f0;padding:10px;text-align:left;border-bottom:1px solid #dcdde1;}
td{padding:10px;border-bottom:1px solid #efefef;}
.compact td,.compact th{padding:6px;font-size:13px;}
body.dark table{background:var(--dark-card);}
body.dark th{background:var(--dark-bg);color:var(--dark-text);border-bottom-color:#555;}
body.dark td{border-bottom-color:#3a4a59;}
.pagination{margin-top:16px;display:flex;align-items:center;gap:8px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999;}
.modal{width:640px;max-width:94%;background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.3);max-height:86vh;overflow:hidden;display:flex;flex-direction:column;}
#qr-reader{width:100%;height:360px;background:#000;display:flex;align-items:center;justify-content:center;color:#999;border-radius:8px;}
.scan-tools{display:flex;justify-content:space-between;gap:10px;margin-top:10px;align-items:center;}
.scan-btn{padding:10px 14px;border-radius:6px;border:1px solid var(--primary);background:#fff;color:var(--primary);cursor:pointer;}
.modal-body{overflow:auto;flex:1;}
body.dark .modal{background:var(--dark-card);color:var(--dark-text);}
@media (max-width:600px){
  .modal{width:94%;padding:10px;}
  #qr-reader{height:260px;}
  #search{width:100%;}
}
</style>
</head>
<body>
<div id="status">Loading data...</div>
<h2>Spare Parts Search</h2>
<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">Scan (QR / Barcode)</button>
  <button id="btn-refresh" class="btn btn-secondary">Refresh</button>
  <div style="flex:1"></div>
  <div class="toggles">
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Dark</div>
      <label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label>
    </label>
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Compact</div>
      <label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label>
    </label>
  </div>
</div>
<input id="search" type="text" placeholder="Search part / description / category / qty">
<table><thead><tr><th>S.No</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th></tr></thead>
<tbody id="table-body"></tbody></table>
<div class="pagination">
  <button id="prev-page" class="btn btn-secondary">Prev</button>
  <span id="page-info"></span>
  <button id="next-page" class="btn btn-secondary">Next</button>
</div>
<br>
<input id="jumpPage" type="number" placeholder="Go to page"><button onclick="jumpToPage()" class="btn btn-secondary">Go</button>

<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog">
    <div class="modal-body">
      <h3 class="modal-header">Scanner (QR + Barcode)</h3>
      <div id="qr-reader">Camera preview will appear here</div>
      <div class="scan-tools">
        <div style="display:flex;gap:8px;">
          <button id="btn-flash" class="scan-btn">Flash</button>
          <button id="btn-photo" class="scan-btn">Scan From Photo</button>
        </div>
        <div style="font-size:13px;color:#666;">Tip: center code inside the preview</div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="qr-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<script>
// ===================== LOUD BEEP + AUDIO UNLOCK =====================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "square";
  osc.frequency.value = 440;
  gain.gain.value = 0.2;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.1);
}

// ===================== DATA LOGIC =====================
let items = [], currentPage = 1, perPage = 50;
let isDark = localStorage.getItem('darkMode')==='true';
let isCompact = localStorage.getItem('compactMode')==='true';
if(isDark) document.body.classList.add('dark');
if(isCompact) document.body.classList.add('compact');
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;
document.getElementById('darkToggle').addEventListener('change',()=>{isDark=!isDark;document.body.classList.toggle('dark',isDark);localStorage.setItem('darkMode',isDark);});
document.getElementById('compactToggle').addEventListener('change',()=>{isCompact=!isCompact;document.body.classList.toggle('compact',isCompact);localStorage.setItem('compactMode',isCompact);});

const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";
const mockData = [{ "item no":"0720","part no":"0720","description":"0720 AC CONDENSOR NIS PICK UP 02-09","category":"AC PARTS ITEMS","qty":"0" }];

function cleanKeys(o){let r={};for(let k in o)r[k.trim()]=(o[k]+"").trim();return r;}
function render(){
  let q=document.getElementById('search').value.toLowerCase();
  let filtered = items.filter(r=>q.split(" ").every(w=>Object.values(r).join(" ").toLowerCase().includes(w)));
  let totalPages=Math.max(1,Math.ceil(filtered.length/perPage));
  if(currentPage>totalPages)currentPage=totalPages;
  let start=(currentPage-1)*perPage;
  let tbody=document.getElementById('table-body'); tbody.innerHTML="";
  filtered.slice(start,start+perPage).forEach((r,i)=>{
    tbody.innerHTML+=`<tr><td>${start+i+1}</td><td>${r["item no"]}</td><td>${r["part no"]}</td><td>${r["description"]}</td><td>${r["category"]}</td><td>${r["qty"]}</td></tr>`;
  });
  document.getElementById('page-info').textContent=`Page ${currentPage} of ${totalPages}`;
  document.getElementById('prev-page').disabled=currentPage===1;
  document.getElementById('next-page').disabled=currentPage===totalPages;
}
document.getElementById('search').addEventListener('input',()=>{currentPage=1;render();});
document.getElementById('prev-page').onclick=()=>{if(currentPage>1)currentPage--;render();};
document.getElementById('next-page').onclick=()=>{currentPage++;render();};
function jumpToPage(){let p=+document.getElementById('jumpPage').value;if(p>0){currentPage=p;render();}}
function loadData(){
  document.getElementById('status').textContent="Fetching records...";
  fetch(SHEETDB_BASE).then(r=>r.json()).then(d=>{items=d.map(cleanKeys);document.getElementById('status').textContent="Loaded "+items.length+" records.";render();})
  .catch(()=>{document.getElementById('status').textContent="Offline – sample data";items=mockData;render();});
}
loadData();
document.getElementById('btn-refresh').onclick=loadData;

// ===================== SCANNER – FIXED & BULLETPROOF =====================
let qrScanner = null;
let scanLock = false;

// Load html5-qrcode library properly (synchronous + guaranteed)
async function loadScannerLibrary() {
  if (window.Html5Qrcode) return;
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js';
    script.onload = () => { console.log("html5-qrcode loaded"); resolve(); };
    script.onerror = () => reject(new Error("Failed to load scanner library"));
    document.head.appendChild(script);
  });
}

async function openQR() {
  document.getElementById('qr-backdrop').style.display = 'flex';

  // Silent audio unlock for iOS/Android
  try { audioCtx.resume(); } catch(e) {}

  // Load library if not already loaded
  try { await loadScannerLibrary(); } catch(e) {
    alert("Failed to load scanner library. Check internet connection.");
    closeQR(); return;
  }

  // Start scanner
  qrScanner = new Html5Qrcode("qr-reader");
  const config = { fps: 15, qrbox: { width: 250, height: 250 }, formatsToSupport: [
    Html5QrcodeSupportedFormats.QR_CODE,
    Html5QrcodeSupportedFormats.EAN_13,
    Html5QrcodeSupportedFormats.EAN_8,
    Html5QrcodeSupportedFormats.UPC_A,
    Html5QrcodeSupportedFormats.CODE_128
  ]};

  qrScanner.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      if (scanLock) return;
      scanLock = true;
      playBeep();
      document.getElementById('search').value = decodedText.trim();
      currentPage = 1; render();
      setTimeout(closeQR, 300);
    },
    () => {}
  ).catch(err => {
    alert("Camera access denied or unavailable");
    closeQR();
  });
}

function closeQR() {
  if (qrScanner) { qrScanner.stop().catch(()=>{}); qrScanner.clear(); qrScanner = null; }
  document.getElementById('qr-backdrop').style.display = 'none';
  scanLock = false;
}

// Buttons
document.getElementById('btn-scan').onclick = openQR;
document.getElementById('qr-close').onclick = closeQR;
document.getElementById('btn-flash').onclick = async () => {
  if (!qrScanner) return;
  const track = qrScanner.getRunningTrackCapabilities();
  if (track?.torch !== undefined) {
    await qrScanner.applyVideoConstraints({ advanced: [{ torch: !track.torch }] });
  }
};
document.getElementById('btn-photo').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file || !window.Html5Qrcode) return;
    try {
      const result = await Html5Qrcode.scanFileV2(file, true);
      playBeep();
      document.getElementById('search').value = result.decodedText;
      currentPage = 1; render();
    } catch { alert("No code found in image"); }
  };
  input.click();
};
</script>
</body>
</html>
